// Prisma schema file

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String   @id @default(uuid())
  username     String   @unique @db.VarChar(50)
  email        String   @unique @db.VarChar(255)
  passwordHash String   @map("password_hash") @db.VarChar(255)
  isOnline     Boolean  @default(false) @map("is_online")
  lastSeen     DateTime @default(now()) @map("last_seen")
  createdAt    DateTime @default(now()) @map("created_at")

  // Relations
  sentMessages     Message[]                @relation("MessageSender")
  createdChatRooms ChatRoom[]               @relation("ChatRoomCreator")
  participations   ChatRoomParticipant[]
  notifications    Notification[]
  notificationSettings NotificationSettings?
  privacySettings  PrivacySettings?
  contacts         Contact[]                @relation("UserContacts")
  contactOf        Contact[]                @relation("ContactOf")
  blockedUsers     BlockedUser[]            @relation("UserBlocked")
  blockedBy        BlockedUser[]            @relation("BlockedBy")
  hiddenChatRooms  HiddenChatRoom[]

  @@map("users")
}

model ChatRoom {
  id            String   @id @default(uuid())
  name          String?  @db.VarChar(100)
  type          String   @db.VarChar(20)
  createdBy     String   @map("created_by")
  createdAt     DateTime @default(now()) @map("created_at")
  lastMessageAt DateTime @default(now()) @map("last_message_at")

  // Relations
  creator      User                    @relation("ChatRoomCreator", fields: [createdBy], references: [id])
  messages     Message[]
  participants ChatRoomParticipant[]
  notifications Notification[]
  hiddenBy     HiddenChatRoom[]

  @@map("chat_rooms")
}

model Message {
  id         String   @id @default(uuid())
  content    String   @db.Text
  senderId   String   @map("sender_id")
  chatRoomId String   @map("chat_room_id")
  status     String   @default("sent") @db.VarChar(20)
  createdAt  DateTime @default(now()) @map("created_at")

  // Relations
  sender   User     @relation("MessageSender", fields: [senderId], references: [id])
  chatRoom ChatRoom @relation(fields: [chatRoomId], references: [id])

  @@map("messages")
}

model ChatRoomParticipant {
  chatRoomId String   @map("chat_room_id")
  userId     String   @map("user_id")
  role       String   @default("member") @db.VarChar(20)
  joinedAt   DateTime @default(now()) @map("joined_at")

  // Relations
  chatRoom ChatRoom @relation(fields: [chatRoomId], references: [id])
  user     User     @relation(fields: [userId], references: [id])

  @@id([chatRoomId, userId])
  @@map("chat_room_participants")
}

model Notification {
  id         String   @id @default(uuid())
  userId     String   @map("user_id")
  type       String   @db.VarChar(20)
  title      String   @db.VarChar(255)
  content    String   @db.Text
  chatRoomId String?  @map("chat_room_id")
  isRead     Boolean  @default(false) @map("is_read")
  priority   String   @default("normal") @db.VarChar(10)
  createdAt  DateTime @default(now()) @map("created_at")

  // Relations
  user     User      @relation(fields: [userId], references: [id])
  chatRoom ChatRoom? @relation(fields: [chatRoomId], references: [id])

  @@map("notifications")
}

model NotificationSettings {
  userId               String   @id @map("user_id")
  soundEnabled         Boolean  @default(true) @map("sound_enabled")
  desktopNotifications Boolean  @default(true) @map("desktop_notifications")
  mentionNotifications Boolean  @default(true) @map("mention_notifications")
  groupNotifications   Boolean  @default(true) @map("group_notifications")
  updatedAt            DateTime @default(now()) @map("updated_at")

  // Relations
  user User @relation(fields: [userId], references: [id])

  @@map("notification_settings")
}

model PrivacySettings {
  userId              String   @id @map("user_id")
  showOnlineStatus    Boolean  @default(true) @map("show_online_status")
  showLastSeen        Boolean  @default(true) @map("show_last_seen")
  allowContactsOnly   Boolean  @default(false) @map("allow_contacts_only")
  updatedAt           DateTime @default(now()) @map("updated_at")

  // Relations
  user User @relation(fields: [userId], references: [id])

  @@map("privacy_settings")
}

model Contact {
  userId    String   @map("user_id")
  contactId String   @map("contact_id")
  addedAt   DateTime @default(now()) @map("added_at")

  // Relations
  user    User @relation("UserContacts", fields: [userId], references: [id])
  contact User @relation("ContactOf", fields: [contactId], references: [id])

  @@id([userId, contactId])
  @@map("contacts")
}

model BlockedUser {
  userId        String   @map("user_id")
  blockedUserId String   @map("blocked_user_id")
  blockedAt     DateTime @default(now()) @map("blocked_at")

  // Relations
  user        User @relation("UserBlocked", fields: [userId], references: [id])
  blockedUser User @relation("BlockedBy", fields: [blockedUserId], references: [id])

  @@id([userId, blockedUserId])
  @@map("blocked_users")
}

model HiddenChatRoom {
  userId     String   @map("user_id")
  chatRoomId String   @map("chat_room_id")
  hiddenAt   DateTime @default(now()) @map("hidden_at")

  // Relations
  user     User     @relation(fields: [userId], references: [id])
  chatRoom ChatRoom @relation(fields: [chatRoomId], references: [id])

  @@id([userId, chatRoomId])
  @@map("hidden_chat_rooms")
}